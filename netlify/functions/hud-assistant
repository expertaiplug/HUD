const Anthropic = require('@anthropic-ai/sdk');

const anthropic = new Anthropic({
  apiKey: process.env.CLAUDE_API_KEY,
});

exports.handler = async (event, context) => {
  const headers = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Headers': 'Content-Type',
    'Access-Control-Allow-Methods': 'POST, OPTIONS',
  };

  if (event.httpMethod === 'OPTIONS') {
    return { statusCode: 200, headers, body: '' };
  }

  if (event.httpMethod !== 'POST') {
    return { 
      statusCode: 405, 
      headers, 
      body: JSON.stringify({ error: 'Method not allowed' }) 
    };
  }

  try {
    const { action, ...data } = JSON.parse(event.body);
    
    let result;
    
    switch (action) {
      case 'analyze':
        result = await handleMarketAnalysis(data.zipCode);
        break;
      case 'chat':
        result = await handleChatMessage(data.message, data.conversationHistory, data.currentMarketData);
        break;
      case 'trends':
        result = await handleMarketTrends();
        break;
      default:
        throw new Error('Invalid action. Use: analyze, chat, or trends');
    }

    return {
      statusCode: 200,
      headers,
      body: JSON.stringify(result),
    };
  } catch (error) {
    console.error('HUD Assistant Error:', error);
    return {
      statusCode: 500,
      headers,
      body: JSON.stringify({ 
        error: error.message || 'Internal server error',
        details: 'Please try again or contact support if the issue persists.'
      }),
    };
  }
};

// ===== MARKET ANALYSIS HANDLER =====
async function handleMarketAnalysis(zipCode) {
  try {
    // Validate ZIP code
    if (!zipCode || !/^\d{5}$/.test(zipCode)) {
      throw new Error('Invalid ZIP code format');
    }

    // Use Claude to analyze the market with HUD data knowledge
    const prompt = `You are a HUD Section 8 investment expert with access to comprehensive Fair Market Rent (FMR) data and market analysis capabilities.

ANALYZE ZIP CODE: ${zipCode}

Provide a detailed Section 8 investment analysis including:

1. Market location (city, state)
2. Current Fair Market Rent rates for 2BR and 3BR units
3. Estimated market rent rates for comparison
4. Voucher utilization rates in the area
5. Average wait times for Section 8 approval
6. Investment score (0-100) based on:
   - Section 8 premium percentages
   - Market demand and utilization
   - Risk factors and stability
7. Overall investment recommendation

Respond in this EXACT JSON format:
{
  "city": "City Name",
  "state": "ST",
  "zipCode": "${zipCode}",
  "analysis": {
    "2br": {
      "fmrRate": 1200,
      "marketRate": 1000
    },
    "3br": {
      "fmrRate": 1500,
      "marketRate": 1250
    },
    "overall": {
      "voucherUtilization": 94,
      "avgWaitTime": 18,
      "investmentScore": 85,
      "riskLevel": "Low",
      "marketStrength": "Strong"
    }
  },
  "dataSource": "HUD FMR Database 2024",
  "lastUpdated": "${new Date().toISOString()}"
}

Provide realistic data based on actual HUD market patterns. DO NOT include any text outside the JSON structure.`;

    const response = await anthropic.messages.create({
      model: 'claude-3-5-sonnet-20241022',
      max_tokens: 1500,
      messages: [{ 
        role: 'user', 
        content: prompt
      }]
    });

    let responseText = response.content[0].text;
    
    // Clean up the response to ensure it's valid JSON
    responseText = responseText.replace(/```json\n?/g, "").replace(/```\n?/g, "").trim();
    
    const marketData = JSON.parse(responseText);
    
    return marketData;

  } catch (error) {
    console.error('Market analysis error:', error);
    
    // Fallback with realistic mock data based on ZIP code
    return generateFallbackMarketData(zipCode);
  }
}

// ===== CHAT MESSAGE HANDLER =====
async function handleChatMessage(message, conversationHistory = [], currentMarketData = null) {
  try {
    // Build context for Claude
    let contextPrompt = `You are a HUD Section 8 investment expert assistant. You have deep knowledge of:
- Fair Market Rent (FMR) data and calculations
- Section 8 voucher programs and requirements
- Real estate investment analysis for rental properties
- HUD regulations and compliance
- Market analysis and ROI calculations

Your personality: Professional but approachable, data-driven, helpful, and encouraging for legitimate investors.

`;

    if (currentMarketData) {
      contextPrompt += `CURRENT MARKET CONTEXT:
User is currently analyzing: ${currentMarketData.city}, ${currentMarketData.state} (ZIP: ${currentMarketData.zipCode})
- 2BR FMR: ${currentMarketData.fmr_2br}
- 3BR FMR: ${currentMarketData.fmr_3br}
- Investment Score: ${currentMarketData.investment_score}/100
- Market Strength: ${currentMarketData.market_strength}

`;
    }

    contextPrompt += `User question: "${message}"

Provide helpful, accurate information about Section 8 investing. Keep responses conversational but informative. If asked about specific markets, use general knowledge and encourage using the analysis tool for current data.`;

    // Build conversation history for Claude
    const messages = [];
    
    // Add context as system message equivalent
    messages.push({ role: 'user', content: contextPrompt });
    
    // Add conversation history if available
    if (conversationHistory && conversationHistory.length > 0) {
      conversationHistory.slice(-6).forEach(msg => {
        messages.push(msg);
      });
    }
    
    // Add current message
    messages.push({ role: 'user', content: message });

    const response = await anthropic.messages.create({
      model: 'claude-3-5-sonnet-20241022',
      max_tokens: 800,
      messages: messages
    });

    return {
      reply: response.content[0].text,
      timestamp: new Date().toISOString()
    };

  } catch (error) {
    console.error('Chat error:', error);
    
    // Fallback responses based on message content
    return {
      reply: generateFallbackChatResponse(message),
      timestamp: new Date().toISOString()
    };
  }
}

// ===== MARKET TRENDS HANDLER =====
async function handleMarketTrends() {
  try {
    const prompt = `You are a HUD Section 8 market analyst. Provide current top-performing Section 8 markets across the United States.

Include 5 markets with strong Section 8 investment potential, showing:
- City and state
- Section 8 premium percentage above market rent
- Voucher utilization rate
- Investment score (0-100)
- Market momentum (strong/moderate/emerging)

Focus on realistic, diverse geographic markets with actual strong Section 8 performance.

Respond in this EXACT JSON format:
{
  "markets": [
    {
      "city": "Atlanta",
      "state": "GA", 
      "premium": 15.4,
      "utilization": 94,
      "investmentScore": 85,
      "momentum": "strong"
    }
  ],
  "insights": {
    "topPerformer": {
      "city": "Atlanta",
      "state": "GA",
      "premium": 15.4
    },
    "summary": "Strong demand continues in Southeast markets with robust economic growth."
  },
  "lastUpdated": "${new Date().toISOString()}"
}

DO NOT include any text outside the JSON structure.`;

    const response = await anthropic.messages.create({
      model: 'claude-3-5-sonnet-20241022',
      max_tokens: 1000,
      messages: [{ 
        role: 'user', 
        content: prompt
      }]
    });

    let responseText = response.content[0].text;
    responseText = responseText.replace(/```json\n?/g, "").replace(/```\n?/g, "").trim();
    
    const trendsData = JSON.parse(responseText);
    
    return trendsData;

  } catch (error) {
    console.error('Trends error:', error);
    
    // Fallback static trends data
    return {
      markets: [
        { city: 'Atlanta', state: 'GA', premium: 15.4, utilization: 94, investmentScore: 85, momentum: 'strong' },
        { city: 'Tampa', state: 'FL', premium: 15.0, utilization: 96, investmentScore: 82, momentum: 'strong' },
        { city: 'Charlotte', state: 'NC', premium: 13.6, utilization: 92, investmentScore: 78, momentum: 'moderate' },
        { city: 'Houston', state: 'TX', premium: 13.0, utilization: 89, investmentScore: 75, momentum: 'moderate' },
        { city: 'Phoenix', state: 'AZ', premium: 12.5, utilization: 91, investmentScore: 73, momentum: 'emerging' }
      ],
      insights: {
        topPerformer: { city: 'Atlanta', state: 'GA', premium: 15.4 },
        summary: 'Southeast markets showing strongest Section 8 performance with high utilization rates.'
      },
      lastUpdated: new Date().toISOString()
    };
  }
}

// ===== FALLBACK FUNCTIONS =====

function generateFallbackMarketData(zipCode) {
  // Generate realistic fallback data based on ZIP code patterns
  const zipInt = parseInt(zipCode);
  const cityStateMap = {
    '30309': { city: 'Atlanta', state: 'GA', multiplier: 1.15 },
    '33602': { city: 'Tampa', state: 'FL', multiplier: 1.12 },
    '28202': { city: 'Charlotte', state: 'NC', multiplier: 1.08 },
    '77002': { city: 'Houston', state: 'TX', multiplier: 1.05 },
    '85003': { city: 'Phoenix', state: 'AZ', multiplier: 1.03 }
  };

  // Default to a generic market if ZIP not in map
  let location = cityStateMap[zipCode] || { 
    city: 'Metro Area', 
    state: 'US', 
    multiplier: 1.0 + (zipInt % 20) / 100 
  };

  const baseFMR2BR = 900 + (zipInt % 500);
  const baseFMR3BR = 1200 + (zipInt % 600);
  
  return {
    city: location.city,
    state: location.state,
    zipCode: zipCode,
    analysis: {
      '2br': {
        fmrRate: Math.round(baseFMR2BR * location.multiplier),
        marketRate: Math.round(baseFMR2BR * 0.9)
      },
      '3br': {
        fmrRate: Math.round(baseFMR3BR * location.multiplier),
        marketRate: Math.round(baseFMR3BR * 0.88)
      },
      overall: {
        voucherUtilization: 85 + (zipInt % 15),
        avgWaitTime: 12 + (zipInt % 24),
        investmentScore: 60 + Math.round((location.multiplier - 1) * 200),
        riskLevel: location.multiplier > 1.1 ? 'Low' : 'Moderate',
        marketStrength: location.multiplier > 1.1 ? 'Strong' : 'Moderate'
      }
    },
    dataSource: 'HUD FMR Database 2024 (Estimated)',
    lastUpdated: new Date().toISOString()
  };
}

function generateFallbackChatResponse(message) {
  const lowerMessage = message.toLowerCase();
  
  if (lowerMessage.includes('roi') || lowerMessage.includes('return')) {
    return "ROI for Section 8 properties typically includes: rental income (often 10-20% above market rate), reduced vacancy (guaranteed payments), but also consider additional inspections and regulations. Use the analysis tool above to get specific market data for better calculations!";
  }
  
  if (lowerMessage.includes('best market') || lowerMessage.includes('where to invest')) {
    return "Great markets typically have: high voucher utilization (85%+), reasonable wait times (under 24 months), and strong FMR premiums above market rent. Check our live market trends above, and analyze specific ZIP codes you're considering!";
  }
  
  if (lowerMessage.includes('property') || lowerMessage.includes('what to look for')) {
    return "For Section 8 properties, focus on: properties that meet HUD quality standards, good neighborhoods with low crime, proximity to public transportation, and rent at or below FMR limits. Always verify local PHA requirements first!";
  }
  
  return "I'd be happy to help with your Section 8 investment questions! I can assist with market analysis, ROI calculations, property selection criteria, and compliance requirements. Try using the ZIP code analyzer above for specific market data, or ask me about any aspect of Section 8 investing.";
}
